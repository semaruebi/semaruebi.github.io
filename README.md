# エリかるて！ 💉
原神の精鋭狩りナレッジベース

## 📋 プロジェクト概要
原神の精鋭狩りRTA（Real Time Attack）のための知識共有プラットフォームなのよ💉
ルートごとのコツや動画、画像を投稿して、コメントで議論できるわ。みんなの健康管理はウチが担当するのよ！

## 🛠️ 技術スタック
- **Frontend**: HTML5, CSS3, Vanilla JavaScript (No Framework)
- **Backend**: Google Apps Script (GAS)
- **Database**: Google Spreadsheet
- **Storage**: Google Drive（画像保存用）
- **Hosting**: GitHub Pages

## 📁 ファイル構造（v4.0 - 精鋭タグ機能追加）

```
gieedb/
├── index.html              # メインHTML
├── js/                    # JavaScript分割版
│   ├── config.js         # 設定（GAS API URL、リトライ設定等）
│   ├── utils.js          # ユーティリティ関数（エスケープ、デバウンス、トースト等）
│   ├── theme.js          # テーマ管理（テーマ切り替え、読み込み）
│   ├── api.js            # API通信（データ取得、コメント送信、問い合わせ等）
│   ├── modal.js          # モーダル関連（画像、ルート詳細、About、問い合わせ）
│   ├── search.js         # 検索機能（サジェスト、部分一致検索）
│   ├── image.js          # 画像プレビュー・ドラッグ&ドロップ
│   ├── ui.js             # UI操作（サイドバー、ホーム、フィルタ、いいね、コメント等）
│   ├── card.js           # カード生成（HTML生成、コメントツリー、精鋭タグ表示等）
│   ├── card-expand.js    # カード詳細モーダル
│   ├── navigation.js     # ナビゲーション（ルート遷移）
│   ├── drag-scroll.js    # ドラッグスクロール機能
│   ├── elite-enemy.js    # 精鋭選択機能（曖昧マッチング、モーダル）
│   ├── elite-enemy-images.js # 精鋭画像リスト（自動生成）
│   ├── post.js           # 投稿関連（投稿、編集、削除、フォーム設定等）
│   └── main.js           # 初期化（window.onload、ドラッグ&ドロップ設定）
├── css/                   # CSS分割版
│   ├── variables.css     # CSS変数とテーマ定義（3テーマ）
│   ├── base.css          # ベーススタイル（body、スクロールバー、トースト等）
│   ├── layout.css         # レイアウト（header、sidebar、navigation等）
│   ├── components.css    # コンポーネント（card、badge、button、form、精鋭タグ等）
│   ├── modal.css         # モーダル関連（精鋭選択モーダル含む）
│   └── responsive.css    # レスポンシブ（メディアクエリ）
├── assets/               # 静的アセット
│   └── images/
│       ├── sigewinne/    # シグウィン画像（4枚）
│       └── eliteenemies/ # 精鋭アイコン（47枚）
├── scripts/              # 自動化スクリプト
│   ├── update-elite-images.js  # 画像リスト自動生成
│   └── update-elite-images.bat # Windows用バッチ
├── old/                   # 旧ファイル（バックアップ）
├── .github/
│   └── workflows/
│       └── ci.yml        # GitHub Actions CI/CD設定
├── README.md             # このファイル
├── CONTRIBUTING.md       # 開発ガイド・ブランチ戦略
├── README_画像更新.md    # 精鋭画像追加手順
├── PERFORMANCE.md        # パフォーマンス分析
├── 精鋭タグ機能_GAS更新手順.md # GAS更新手順
├── package.json          # npm設定・テストスクリプト
├── .eslintrc.json        # ESLint設定
├── .stylelintrc.json     # Stylelint設定
├── .gitignore            # Git除外設定
└── handoff.md            # 開発用ドキュメント
```

## 🔧 設定・環境

### GAS API URL設定
`js/config.js`でGAS API URLを設定するのよ：
```javascript
const CONFIG = {
    GAS_API_URL: "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec",
    // ... その他の設定
};
```

### 外部依存関係
- **Font Awesome 6.4.0** (CDN) - アイコン表示
- **Google Fonts** - Kiwi Maru, M PLUS Rounded 1c, Zen Maru Gothic
- **Twitter Widgets** (CDN) - ツイート埋め込み

### ローカルストレージ使用項目
- `rta_theme` - 選択中のテーマ（dark/light/sigewinne）
- `rta_liked_posts` - いいね済み投稿ID配列
- `rta_liked_comments` - いいね済みコメントID配列

## 🗄️ データ構造

### Google Spreadsheet（想定構造）
- **routesシート**: 地域・ルート情報（region, route, imageUrl, description）
- **postsシート**: 投稿データ（id, region, route, content, imageUrl, tags, likes, timestamp, title）
- **commentsシート**: コメントデータ（id, postId, parentId, content, likes, timestamp）
- **EEsシート**: 精鋭データ（中分類、要素1、要素2、要素3...）- 精鋭タグ選択用
- **contactsシート**: 要望・問い合わせ（timestamp, type, name, message）
- **access_logシート**: アクセスログ（プライバシーに配慮した最小限のログ）

### タグシステム
- **必須タグ（レギュレーション）**: NPuI, PuA, PuI, 全般
- **必須タグ（Cost）**: 制限なし、低凸、Cost全般
- **オプションタグ**: 誘導、弓起動、処理法、位置調整、コツ、注意点
- **自由タグ**: 最大2つ（ユーザー入力）
- **精鋭タグ（任意）**: 画像アイコンで精鋭を選択、曖昧マッチングで自動紐付け

## 🚀 デプロイ方法

### GitHub Pages（自動デプロイ）
1. `main`ブランチにプッシュすると自動的にGitHub Pagesへデプロイされるわ
2. GitHub Actions CIが自動的にテストを実行してからデプロイ
3. `https://[username].github.io/[repository-name]/` でアクセスできるのよ

### GAS側の設定
- GASプロジェクトでWebアプリとして公開するのよ（実行ユーザー: 自分、アクセス権限: 全員）
- 公開URLを`js/config.js`の`CONFIG.GAS_API_URL`に設定してね

## 🧪 開発とテスト

### 依存関係のインストール
```bash
npm install
```

### テスト実行
```bash
# すべてのテストを実行
npm test

# 個別実行
npm run lint:js        # JavaScript リント
npm run lint:css       # CSS リント
npm run validate:html  # HTML バリデーション
npm run check:images   # 画像存在確認
```

### CI/CD パイプライン
GitHub Actionsが自動的に以下を実行するわ：
- **プッシュ時**：JavaScript/CSS リント、HTML バリデーション、画像チェック
- **mainブランチマージ時**：上記すべて＋GitHub Pagesへ自動デプロイ

詳しい開発フローは [`CONTRIBUTING.md`](CONTRIBUTING.md) を見てね💉

## 💡 主要機能の実装詳細

### テーマ切り替え
- `cycleTheme()`: 夜の診療所 → シグウィンデイタイム → おシグテイスト → 夜の診療所の順で循環するのよ
- `localStorage`に保存されるから、次に来た時も同じテーマで迎えるわ

### 検索・フィルタリング
- **スマート検索**: 本文・タイトル・タグすべてを部分一致で一括検索するのよ
- **タグサジェスト**: 既存タグからオートコンプリート表示してあげるわ
- **サイドバー**: 地域・ルートで階層的にフィルタリングできるの
- **精鋭タグ検索**: 精鋭名の部分一致でも検索できるわよ（例：「氷」で氷蛍術師をヒット）

### 精鋭タグシステム
- **画像アイコン**: 47種の精鋭を視覚的に選択できるのよ
- **曖昧マッチング**: スプレッドシートの精鋭名と画像ファイル名が完全一致しなくても自動紐付け
- **ツールチップ**: ホバーで精鋭名を表示してあげるわ
- **自動化**: `scripts/update-elite-images.bat` で画像リストを自動生成
- **フォールバック**: 画像がない場合はテキスト表示に自動切り替え

### ドラッグスクロール
- **マウス操作**: 人気・最新投稿を掴んで横スクロールできるのよ
- **クリック判定**: ドラッグとクリックを自動判別（5px閾値）
- **スムーズスクロール**: 滑らかな動きで快適に閲覧できるわ
- **スナップ**: 手を離すと近くのカードにスナップするの

### 画像アップロード
- 最大4枚、各2MB以下なのよ。転ばないようにね
- Base64エンコードしてGASに送信するわ
- GAS側でGoogle Driveに保存して、公開URLを返却してくれるの

### 精鋭タグ機能（NEW in v4.0）
- **画像アイコン表示**: 47種類の精鋭を画像で選択できるわ
- **曖昧マッチング**: スプレッドシートの精鋭名と画像ファイルを自動紐付けするの
- **ホバーツールチップ**: 画像にマウスを乗せると精鋭名が表示されるわよ
- **自動化**: `scripts/update-elite-images.bat` で画像リストを自動生成できるのよ
- **部分一致検索**: 精鋭名で検索すると該当投稿が見つかるわ

### ドラッグスクロール機能（NEW in v4.0）
- 人気の投稿・最新の投稿を横スクロール表示するのよ
- マウスでドラッグして快適にスクロールできるわ
- クリックで詳細モーダルが開くの
- スマホでも使いやすいUIなのよ💉

### コメント機能
- スレッド形式（`parentId`で階層管理）なのよ
- 再帰的に`renderCommentTree()`で表示してるわ
- 各コメントに個別のいいね機能があるの

### レスポンシブ対応
- ブレークポイント: 900pxなのよ
- スマホ: サイドバーは左からのオーバーレイで、スワイプで閉じられるわ
- PC: 常時表示の2カラムレイアウトよ

## ⚠️ 注意事項

1. **CORS制限**: GAS APIは`mode: "no-cors"`で送信してるから、レスポンスの詳細なエラーハンドリングが難しいのよ
2. **レート制限**: 連続で更新ボタンを押すとGAS側でエラーになっちゃうわ。力を抜いて、リラックスするのよ（エラーメッセージで注意喚起済み）
3. **画像サイズ**: 2MB制限はフロントエンドのみなの。GAS側でも検証を推奨するわ
4. **セキュリティ**: 削除パスワードは平文で送信してるのよ（GAS側で検証）

## 🔮 今後の拡張候補

- ✅ 投稿の編集機能（実装済み）
- ✅ 画像のドラッグ&ドロップ対応（実装済み）
- ✅ ドラッグスクロール機能（実装済み）
- ✅ 精鋭タグ機能（実装済み）
- ✅ 投稿の並び替え（実装済み：日付、いいね数、コメント数順）
- ✅ エクスポート機能（実装済み：ブックマークのJSON/テキスト出力）
- ✅ 統計ページ（実装済み：人気ルート、よく使われる精鋭など）
- ✅ ブックマーク機能（実装済み）
- ユーザー認証機能を追加したいわね
- プッシュ通知機能があると便利よね

## 🔄 改修履歴

### v5.0 - ユーザー体験大幅向上 💉✨
**リリース日**: 2025-12-02

#### 新機能
- ✅ **投稿の並び替え機能**: 新しい順・古い順・いいね順・コメント順で自由に並び替えできるようになったのよ！
- ✅ **ブックマーク機能**: お気に入りの投稿を保存して、いつでも見返せるわ💉
  - ブックマーク一覧ページ
  - JSON/テキスト形式でエクスポート
  - サイドバーから簡単アクセス
- ✅ **統計ダッシュボード**: みんなの投稿を分析した結果を見られるのよ📊
  - 人気ルートTOP10
  - よく使われる精鋭TOP10
  - タグ使用頻度TOP10（ビジュアライズ付き）
  - 最も議論されている投稿TOP5
  - 総投稿数・いいね数・コメント数の統計サマリー

#### UI/UX改善
- ✅ **いいねボタンアニメーション**: ハートがポップに弾むアニメーションを追加したわ❤️
- ✅ **カードホバーエフェクト**: カードにマウスを乗せると浮き上がるエフェクトを強化したの
- ✅ **コンパクトカードアニメーション**: 横スクロールカードのホバー時にグラデーション背景を追加
- ✅ **スムーズトランジション**: 全体的なアニメーションをより滑らかにしたわよ

#### 技術改善
- ✅ localStorageにソート設定とブックマークを永続化
- ✅ 新規JavaScriptファイル追加（bookmark.js, stats.js）
- ✅ ESLintとStylelintの設定を最適化
- ✅ コード品質とメンテナンス性を向上

#### ファイル構成の変更
```
js/
├── bookmark.js        # ブックマーク機能（NEW）
├── stats.js           # 統計ダッシュボード（NEW）
├── ui.js              # ソート機能追加
└── ...
```

### v4.0 - 精鋭タグ機能とUI改善 💉
- ✅ 精鋭タグ選択機能を追加（画像アイコン表示、曖昧マッチング）したわ
- ✅ ドラッグスクロール機能を実装（横スクロールカード）したの
- ✅ カード詳細モーダルを追加（コンパクト表示→展開）したわよ
- ✅ シグウィン画像を4種類追加（サイドバー、About、ローディング、空状態）したの
- ✅ 精鋭アイコン画像47個を追加（自動マッチング）したわ
- ✅ 検索機能を部分一致に統一（タグも部分一致）したの
- ✅ 画像リスト自動生成スクリプトを追加（update-elite-images.bat）したわよ
- ✅ テーマを3つに整理（夜の診療所、シグウィンデイタイム、おシグテイスト）したの

### v4.0 - 精鋭タグ機能と画像表示システム 🐉✨
- ✅ 精鋭選択モーダルを追加（47種の精鋭を画像アイコンで選択）
- ✅ 曖昧マッチングシステム（名前が近ければ自動で画像紐付け）
- ✅ 精鋭タグを画像表示（投稿カード＋投稿フォーム）
- ✅ ホバーでツールチップ表示（精鋭名）
- ✅ 画像リスト自動生成スクリプト（update-elite-images.bat）
- ✅ 検索を部分一致に統一（本文・タイトル・タグすべて）
- ✅ ドラッグスクロール機能（人気・最新投稿を横スクロール）
- ✅ カード詳細モーダル実装（ワンクリック展開）
- ✅ ルート名クリックで該当ページ遷移
- ✅ TOPICクリックでホーム戻り
- ✅ シグウィン画像を各所に配置（サイドバー、About、ローディング、空の状態）
- ✅ 画像モーダルz-index修正（詳細の上に表示）
- ✅ Aboutボタンの視認性改善
- ✅ パフォーマンス分析ドキュメント追加

### v3.1 - コード最適化とシグウィン口調化 💉
- ✅ 重複コードを削減して、健康なコードベースにしたのよ
- ✅ 共通関数の抽出で保守性を向上させたわ
- ✅ ユーザー向けメッセージを全部シグウィン口調に統一したの
- ✅ リンターエラー0件達成なのよ！

### v3.0 - 大規模リファクタリング
- ✅ JavaScriptファイルを10個に分割したのよ（utils, theme, api, modal, search, image, ui, card, post, main）
- ✅ CSSファイルを6個に分割したわ（variables, base, layout, components, modal, responsive）
- ✅ コードの可読性と保守性を大幅に向上させたの
- ✅ ファイル構造の整理と最適化をしたわよ

### v2.0 - 包括的改修
- ✅ GAS API URLを`config.js`に分離したのよ（環境変数化）
- ✅ XSS対策を強化したわ
- ✅ リトライ機能を実装したの
- ✅ アクセシビリティを改善したわよ
- ✅ パフォーマンスを改善したのよ
- ✅ トースト通知システムを実装したわ

---
